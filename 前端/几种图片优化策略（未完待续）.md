---
title: 几种图片优化策略
tags: 图片
notebook: 前端
---
# 几种图片优化策略
### 前言
上次，我们讲过，要从图片本身分析，采用合适的图片格式从而优化图片的资源加载。这次，我们来聊一聊其他角度的优化图片策略。

在网页中，其加载的大部分资源（60%）就是图片资源了，所以优化图片通常可以有效的减少字节数和改善网站的性能，原因就是：**浏览器需要下载的字节数越少，对客户端带宽的争用就越少，浏览器下载内容并在屏幕上呈现的内容的速度就越快**。速度快，性能就肉眼可见的感觉好了很多。

**那么怎么减少对带宽的争用呢？（问题1）**
你可以先从这么几个方面考虑：
- 真的需要这个图片吗？
- 图片格式对了吗？
- 图片的质量设置对了吗？
- 这个分辨率恰当吗？
- 是否可以通过css实现所需效果?
  
2分钟，思考一下，然后就带着你的问题和答案，我们继续往下走，你会逐渐得到答案的。

### 一、如果我们不对图片进行优化，加载效果是怎样？
案例可见：[点击这里]()
#### 首先看下加载时间
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190704160918.png)
根据截图可以看出，一张图片大小从100kB-6MB 不等，图片越大，所需要加载的时间就越多。5MB的就要1s多了，非常可怕。
#### 再看看加载的效果怎样吧
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/imageOrigin2.gif)
这是一张1.79MB的图片，我们从这个动图可以很明显的看出来，它是空白了一下，然后再显示的。再结合上面的加载时间来看，其实这个也就是加载了622ms的效果，那么更大的图片加载不是更延迟了，空白时间更长了。实在一言难尽的可怕。。。根据我们现在浏览页面的耐性，一般网页加载超过3s还没出来的，如果不是非常必要，一般都会直接选择关闭这个网页，回头再来的可能性基本为0，除非不得不来.

### 二、那现在市面上其他公司是怎么做的？
#### 淘宝网
对于图片较多的网站，比如淘宝，图片对其加载效果的影响是百分百的，所以他们势必会对图片做出一些优化措施，我们来试图看看能看到的优化措施。
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/taobao2.gif)
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190704174413.png)
图片域名有很多，采用了cdn分布式存储，
> cdn的优势：将源站内容分发至最接近用户的节点，是用户可就近取得所需内容，提高用户的响应速度和成功率。解决因分布、带宽、服务器性能带来的访问延迟问题。
> ——阿里云CDN介绍

![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190704180244.png)
采用响应式图片，根据浏览器窗口大小进行判断，返回对应大小的图片。
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/201907072216.png)
有的图片是来自*serviceWorker*，emmmm，给第一次见到这个的人简单介绍下它吧（比如我自己），提示：这是关于缓存的。
Service Workers是谷歌chrome团队提出并大力推广的一项web技术。2015年加入W3C标准。这里是MDN上的介绍
> Service workers essentially act as proxy servers that sit between web applications, and the browser and network (when available). They are intended to (amongst other things) enable the creation of effective offline experiences, intercepting network requests and taking appropriate action based on whether the network is available and updated assets reside on the server. They will also allow access to push notifications and background sync APIs. 
> ——MDN


大概意思就是：Service Worker 基本上是作为两个web应用服务器之间的代理服务器，就是介于浏览器和服务器的中间层，可拦截service worker所负责的页面（指定client）所发起的所有请求，并返回响应资源，使得离线web应用成为了可能。
主要是用于PWA(progress Web App)，就是让web也像app一样，可以添加到桌面，消息推送，*离线使用*等,其中关键点就是离线使用，这就是service Worker所起的作用：**拦截client的请求，根据请求把请求后的response用浏览器缓存caches缓存下来，从而实现离线的使用**(本文大概知道这个一个概念就好，因为细谈的话内容就又多多多了起来，**记住关键词：缓存！**)
目前国内采用了service Worker的有：淘宝、网易、
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/201907072215.png)
这里有个地方是很重要的,就是那个http请求协议，可以很明显的看到，淘宝现在部分请求已采用hhtp2的协议了，http2是http1.1的一个大升级，解决了很多http1.1的通病，比如：TCP连接数限制，线程阻塞，**要尽可能地减少请求数（划重点！）**，数据不安全等。
从前，为了减少请求数，就要做合并文件，雪碧图，资源内联等优化工作，但是这个其实并没有很好地解决资源加载的问题，合并就会导致单个请求内容变大，延迟变高的问题，且内联的资源不能有效地使用缓存机制。
现在，换了http2，就可以不用做这些优化操作了，使用http2 可以尽可能地将资源细粒化，文件分解地尽可能散，不用担心请求数多。
（具体区别还是一个大课题，这里就不拓展了，感兴趣的可以百度搜一下*http 2*，或者点击文章最后的参考链接，**记住关键词：http请求数**）
最后，不得不说，淘宝果然是淘宝啊。
#### 那看看我们的网站是个什么情况吧。
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/201907072231.png)
从截图上看，还是属于比较传统的http1.1，需要尽可能地减少请求数。且图片并不是响应式的。唯一的图片服务器，服务器位置固定，所以用户离得远，所请求的响应就会相对慢一些。

### 三、图片优化的本质
说起图片优化，其实有很多方法，比如上面说到的雪碧图，图片懒加载等等，但是最后总结起来还是这2种：图片的大小和http请求数（因为大多数http请求协议还是1.1的，所以请求数还是比较重要的一个点）
#### 2个方面
1. **减少图片的大小**，比如把一张1M的图片在不失真的前提下，减小到200k的大小；
    方法有：图片压缩、采用恰当的图片格式、响应式图片等
2. **减少网站图片资源的http请求数**，http请求越少，网站的性能也就越好。  
   方法有： 雪碧图，懒加载，预加载，渐进式图片加载等
从图片类型来区分：如果是页面的静态资源图片，可以采用css、canvas、svg、iconfont、base64来优化；如果是后台返回的数据资源图片，就可以通过响应式、图片压缩来优化。


### 四、图片优化的几种方法
### 4.1 要恰当的使用图片资源
在优化现有的图片资源之前，先思考一下，**当前网站/页面的图片都是必要的吗？可以用css实现吗？**
如果你的回答是：是，都是必要的，且无法用css实现。那么你可以跳过这一节。  
好的设计是简单而且始终可以提供最佳效果的。相比于图片资源，html、css、js等所需要加载的字节数始终是更少，用这些来替代图片资源无疑是最佳的方法（当然，这是指简单的图片及图形）。所以在实现相同效果的情况下，先思考一下，能不能用css或其他方法实现。  
简单的图片一般来说，有这么几种：基础的图形，颜色简单的图标。  
可以采取的策略有：
  - css效果(渐变、阴影等)和css动画。
    - 这些都可以用于生成与分辨率无关的资源，而且在任何分辨率和缩放级别下始终都能清晰地显示，最重要的是，这些所需要的字节数往往只是图片资源的几分之一而已。
  - 图标字体。
    - 比如[font-awesome](http://fontawesome.dashgame.com/),[阿里巴巴矢量图标库iconfont](https://www.iconfont.cn/),这些都是可以一次引入多个图标，减少了http的请求数。
    ![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190703111521.png)
    ![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190703112717.png)

### 4.2 选择合适的格式
这时候，你已经确定好了，剩下的都是需要图片才能实现的效果，那么就来考虑一下，哪个是这个图片最适合的格式？恰当的图片格式会相对地减少一些不必要的字节数，减少图片大小。(这个，我们上一次已经大致了解过了，现在来简单总结归纳一下，如果还不太清楚，[点击了解一下](https://github.com/heihuahe/lingBook/blob/master/%E5%89%8D%E7%AB%AF/%E5%87%A0%E7%A7%8D%E5%9B%BE%E5%83%8F%E6%A0%BC%E5%BC%8F%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B.md))  
图片主要分为两大类：矢量图和位图（栅格）
- 矢量图：使用点、线、多边形来表示图片，缩放不失真；
  - 适合包含简单几何图形的图像，比如：图标、徽标等。
- 位图：根据像素点进行生成图片，缩放会失真；
  - 适合复杂，细节度高，色彩丰富的图片。
### 4.3 是真正的策略了
已经将图片控制到相对来说较小的大小了，但是图片一多的话，网站的效果还是挺差的，加载依旧很慢，那怎么办呢？大致有这么些方法：
- js
  - 预加载（推荐度：★★）
    - 这是提升用户体验而损失性能的一种做法。就是先将图片加载到浏览器中，然后再显示，保证图片快速地、无缝地发布，给用户的体验就是加载的很“快”，页面打开的很“快”，但是其实对服务器的压力是没有减少的。
  - 懒加载（推荐度：★★★★）
    - 给图片的src赋值为一张默认图片，当用户滚动到可视区域内，再去加载真正的图片。
    - 使用jq的lazyload插件实现图片懒加载，就是等到滚动条滚动到对应的地方再加载所需要的图片资源；
  - 渐进式图片加载（progressive-image）（推荐度：★★★★★）
    - 用低分辨率的模糊图片来做预览图，代替懒加载的logo占位图。用canvas画出预览图。一般大小平均就在2-3kb之间，用户体验较好。知乎就有采用这种方式。
- css 
  - 雪碧图
    - 将简单的小图片做成雪碧图，多个图片合到一个雪碧图上，减少图片资源的请求。
    - 雪碧图的话，如果图片都是单色的，可以考虑用icon-font来实现；或者直接在页面写svg代码和转换成base64写到页面上去。
    - 如果网站的http协议是1.1的时候可以考虑使用，2的话，就可以跳过了。
  - 用css 的devicePixelRatio检查设备的像素比,恰当的使用倍图。
    - 区分设备是视网膜设备还是非视网膜设备，从而来决定加载两倍图还是原始大小的图片。
- 其他
  - 在保证不失真的情况下，用gulp-imagemin工具来压缩图片大小。
  - 响应式图片：就是不同终端使用不同大小的图片

#### 4.3.1 js方面
1. 懒加载
2. 渐进式图片加载

#### 4.3.2 css方面
1. 雪碧图
2. 检查像素比

##### 4.3.2.1 雪碧图
雪碧图，其实就是把很多图标放在一个图片里，然后将合成的图片当作背景图片使用，再根据某个图片其在雪碧图中的位置，进行定位引用。
这样就可以减少图片的http请求。注意：雪碧图不宜太大！
雪碧图的效果大致像这样：
![](https://raw.githubusercontent.com/heihuahe/myGallery/master/noteImage/20190703114405.png)

#### 其他方面
1. 图片压缩
2. 响应式图片

##### 响应式图片
什么事响应式图片？就是在不同的终端平台上加载不同尺寸的图片，避免资源的浪费。
目的：节省不必要的图片资源，因为移动端所需要的图片和PC端的图片尺寸完全不一样。
有几种方式：
1. 可以通过`picture元素`，来判断为不同终端输出不同大小的图片
2. 通过css3的媒体查询，虽然可以实现，但是比较麻烦，只适用于页面的静态资源图片。
3. 通过服务器图片资源配置命名规则来获取图片
4. img的srcset和sizes的方法
这两个img属性是html5的属性，有浏览器兼容问题
###### 生成雪碧图的几种方式
1. 在线生成雪碧图，有[css Sprites Generator](https://www.toptal.com/developers/css/sprite-generator)
2. 用ps


### 举例
- 压缩
  - 图片较大，就要压缩。或者采用cdn
- 合并
  - 比较小的图片，可以做成雪碧图或者直接生成base64编码嵌入网页中，或者在网站上使用webp格式的图片（在移动端用的多）
  - 雪碧图，也不宜过大，200k左右就差不多。
- CDN
  - 图片较大时，建议采用，就是把图片放到阿里OSS或者七牛云里。
- 缓存
- 延时加载
- 独立域名
### 题外话：什么是一倍图和两倍图？要怎么用？
有时候，我们找设计师要一张图片的切图的时候，他们会给我们导出3张，告诉我们这是一倍图，二倍图，三倍图这样。然后，假如你不懂，那么你就懵逼了。“这些倍图是什么东西？我只是要这个图片的切图啊？？？”
一般来说，这些倍图都有命名规则的，比如图片名叫：icon.png，那么一倍图就是原名，二倍图就是icon@2x.png,三倍图就是icon@3x.png。了解命名规则了，那就来看看这些倍图有啥区别吧。
顾名思义啊，一倍图就是原图，二倍、三倍就是在原图的基础上翻倍的，比如icon.png 大小是 `30px*30px`的，那二倍图就是`60px*60px`,三倍图就是`90*90`。
现在，你知道了这些图的区别了，那么我们要怎么用呢？
好像，**倍图一般用于移动端的原生开发，比如andriod和ios里的app，网页的话，如果场景是pc端的，可以不用考虑，但是如果是移动端的h5，还是要根据手机的像素比来判断所要使用的图片，这样效果更好，更高清**。
原理是：当代码在不同分辨率的手机里运行时，系统会自动查找对应的图片，这样就可以很好地适配了。
#### 倍图的应用场景
- 一倍图
  - 用于1：1的屏幕，比如iPhone4，（现在大多数都是直接使用二倍图和三倍图）
  - 屏幕大小：320*480
- 二倍图
  - 用于1：2的屏幕，比如iPhone4s、iPhone5、iPhone5s、iPhone6及后续的iPad等。
  - 屏幕尺寸比如：750*1334
- 三倍图
  - 用于1：3的屏幕，比如iPhone46Plus

#### 移动端H5适配的方法
1. css3的媒体查询（仅使用于页面静态资源图片）
2. js像素判断，``window.devicePixelRatio``
### 参考资料
- [优化图片 (PageSpeed Tools > Insights)](https://developers.google.com/speed/docs/insights/OptimizeImages)
- [图像优化(google developers —— ILya Grigorik)](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/image-optimization#image_optimization_checklist)
- [适用于 vue.js 和原生 js 的渐进式图片加载(GitHub —— ccforward)](https://github.com/ccforward/cc/issues/64)
- [web前端优化之图片优化(掘金——
龙荩草)](https://juejin.im/post/59a7725b6fb9a02497170459)
- [web前端图片极限优化策略(ouven)](https://jixianqianduan.com/frontend-weboptimize/2015/11/17/front-end-image-optmize.html)
- [web前端优化之图片优化(segmentfault——nyflxp)](https://segmentfault.com/a/1190000010967837)
- [移动端H5项目判断使用几倍图(CSDN——weixin_33795093)](https://blog.csdn.net/weixin_33795093/article/details/87382767)
- [http2详解(简书——鱼_乐)](https://www.jianshu.com/p/e57ca4fec26f)
- [Service Workers 与离线缓存(Segmentfault——DiscipleD)](https://segmentfault.com/a/1190000008491458)
- [serviceworker运用与实践(CSDN——布瑞泽的童话)](https://blog.csdn.net/mevicky/article/details/86605882)